<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Road Trip Planner</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Mapbox GL JS -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: contain;
    }
    
    #root {
      width: 100%;
      min-height: 100vh;
    }

    .icon {
      display: inline-block;
      width: 1.25rem;
      height: 1.25rem;
      vertical-align: middle;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: calc(100vh - 180px);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ============================================
    // üîë API CONFIGURATION - ADD YOUR KEYS HERE
    // ============================================
    const API_CONFIG = {
      PROXY_URL: 'https://road-trip-planner-ten.vercel.app/api/proxy'
    };
    // ============================================

    // Simple icon components using SVG
    // const WifiIcon = () => (
    //   <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    //     <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
    //   </svg>
    // );

    // const WifiOffIcon = () => (
    //   <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    //     <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
    //   </svg>
    // );

    const WifiIcon = () => null; //keep the components but make them render nothing
    const WifiOffIcon = () => null; //keep the components but make them render nothing

    const NavigationIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    );

    const MapIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
      </svg>
    );

    const ListIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    );

    const CheckIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
      </svg>
    );

    const MapPinIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );

    const ExternalLinkIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
    );

    const CloudIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
      </svg>
    );

    const CalendarIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    );

    const RefreshIcon = () => (
      <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const LoadingIcon = () => (
      <svg className="icon animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const INITIAL_LOCATIONS = [
      {
        id: "location_001",
        name: "Johnsonville Library | Waitohi",
        address: "34 Moorefield Road, Johnsonville, Wellington",
        googleMapsQuery: "Johnsonville Library | Waitohi, 34 Moorefield Road, Johnsonville, Wellington",
        coordinates: [174.8047, -41.2214],
        day: "November 2",
        dayNumber: 1,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Starting point"
      },
      {
        id: "location_002",
        name: "Green Jersey Bicycle Hire",
        address: "16 Kitchener Street, Martinborough",
        googleMapsQuery: "Green Jersey Bicycle Hire, 16 Kitchener Street, Martinborough",
        coordinates: [175.4602, -41.2194],
        day: "November 2",
        dayNumber: 1,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Bike hire and cycle tours"
      },

  {
    id: "location_003",
        name: "3 Little Words",
        address: "107 Dry River Road, Martinborough",
        googleMapsQuery: "3 Little Words, 107 Dry River Road, Martinborough",
        coordinates: [175.4070, -41.2597],
        day: "November 2",
        dayNumber: 1,
        visited: false,
        booking: { 
          hasBooking: true, 
          time: "2:30 PM", 
          date: "November 2, 2025" 
        },
        //notes: "‚ö†Ô∏è BOOKING CONFIRMED - 2:30 PM"
      },
      //renumber the rest of the locations accordingly
     
      {
        id: "location_004",
        name: "Top 10 Holiday Park",
        address: "Dublin Street, Martinborough",
        googleMapsQuery: "Martinborough Top 10 Holiday Park",
        coordinates: [175.4621, -41.2231],
        day: "November 2",
        dayNumber: 1,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Accommodation"
      },
      {
        id: "location_005",
        name: "Star Safari",
        address: "Martinborough Area",
        googleMapsQuery: "Star Safari Martinborough",
        coordinates: [175.52319312559396, -41.13882696948107],
        day: "November 2",
        dayNumber: 1,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Evening activity"
      },
      {
        id: "location_006",
        name: "Deliverance Cove Track & Castlepoint Lighthouse",
        address: "Castlepoint 5889, Wairarapa",
        googleMapsQuery: "Deliverance Cove Track, Wairarapa",
        coordinates: [176.2167, -40.9000],
        day: "November 3",
        dayNumber: 2,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Lighthouse & beach"
      },


      {
        id: "location_007",
        name: "Amble Inn Motel",
        address: "124 Chapel Street, Masterton",
        googleMapsQuery: "Amble Inn Motel, 124 Chapel Street, Masterton",
        coordinates: [175.6548, -40.9523],
        day: "November 3",
        dayNumber: 2,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Accommodation"
      },


      {
        id: "location_008",
        name: "Harbour View Motel on Ahuriri Napier Beach (with sea view suites)",
        address: "60 Nelson Quay, Ahuriri, Napier 4110",
        googleMapsQuery: "Harbour View Motel on Ahuriri Napier Beach (with sea view suites), 60 Nelson Quay, Ahuriri, Napier 4110",
        coordinates: [176.8975, -39.4793],
        day: "November 4",
        dayNumber: 3,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Accommodation"
      },
      {
        id: "location_009",
        name: "National Aquarium of New Zealand",
        address: "546 Marine Parade, Napier",
        googleMapsQuery: "National Aquarium of New Zealand, 546 Marine Parade, Napier",
        coordinates: [176.9167, -39.4833],
        day: "November 4",
        dayNumber: 3,
        visited: false,
        booking: { 
          hasBooking: true, 
          time: "After 2:00 PM", 
          date: "November 4, 2025" 
        },
        notes: "‚ö†Ô∏è BOOKING CONFIRMED - After 2:00 PM"
      },
      {
        id: "location_010",
        name: "Bell Rock Loop Track",
        address: "Bell Rock, Napier",
        googleMapsQuery: "Bell Rock Loop Track, Napier",
        coordinates: [176.9200, -39.4700],
        day: "November 5",
        dayNumber: 4,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Hiking track"
      },



      {
        id: "location_011",
        name: "Captain Cook Motor Lodge",
        address: "31 Awapuni Road, Awapuni, Gisborne",
        googleMapsQuery: "Captain Cook Motor Lodge, 31 Awapuni Road, Awapuni, Gisborne",
        coordinates: [178.0194, -38.6699],
        day: "November 5",
        dayNumber: 4,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Accommodation"
      },






     
      {
        id: "location_012",
        name: "Cook's Cove Walkway",
        address: "Tolaga Bay Area, Gisborne",
        googleMapsQuery: "Cook's Cove Walkway, Tolaga Bay",
        coordinates: [178.2985, -38.3715],
        day: "November 6",
        dayNumber: 5,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Coastal walkway"
      },
      {
        id: "location_013",
        name: "Dive Tatapouri",
        address: "Tatapouri, Gisborne",
        googleMapsQuery: "Dive Tatapouri, Tatapouri",
        coordinates: [178.1667, -38.6333],
        day: "November 6",
        dayNumber: 5,
        visited: false,
        booking: { 
          hasBooking: true, 
          time: "1:00 PM", 
          date: "November 6, 2025" 
        },
        notes: "‚ö†Ô∏è BOOKING CONFIRMED - 1:00 PM"
      },


      {
        id: "location_014",
        name: "The Mayfair Motel | Hastings",
        address: "1122 Karamu Road North, Mayfair, Hastings",
        googleMapsQuery: "The Mayfair Motel | Hastings, 1122 Karamu Road North, Mayfair, Hastings",
        coordinates: [176.8592, -39.6341],
        day: "November 6",
        dayNumber: 5,
        visited: false,
        booking: { hasBooking: false, time: null, date: null},
        notes: "Accommodation"
      },

      {
        id: "location_015",
        name: "Te Mata Peak",
        address: "Tuki Tuki",
        googleMapsQuery: "Te Mata Peak, Tuki Tuki",
        coordinates: [176.9163, -39.6992],
        day: "November 6",
        dayNumber: 5,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Scenic views"
      },



      {
        id: "location_016",
        name: "Cape Kidnappers",
        address: "Clifton Road, Hastings",
        googleMapsQuery: "Cape Kidnappers, Clifton Road, Hastings",
        coordinates: [176.9167, -39.6500],
        day: "November 6",
        dayNumber: 5,
        visited: false,
        booking: { hasBooking: false, time: null, date: null },
        notes: "Gannet colony"
      },
      
    ];

    const RoadTripPlanner = () => {
      const [activeTab, setActiveTab] = useState('current');
      const [locations, setLocations] = useState([]);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [weather, setWeather] = useState(null);
      const [token, setToken] = useState(null);//add token state
      const [isLoading, setIsLoading] = useState(true);
      const [loadingWeather, setLoadingWeather] = useState(false);
      const [mapContextLost, setMapContextLost] = useState(false);
      const [showRefreshPrompt, setShowRefreshPrompt] = useState(false);
      const [locationRoutes, setLocationRoutes] = useState({});
      const [isLoadingRoutes, setIsLoadingRoutes] = useState(false);
      const [routeError, setRouteError] = useState(null);
      const [mapLoading, setMapLoading] = useState(false);
      const mapContainer = useRef(null);
      const map = useRef(null);

      // Load initial data
      useEffect(() => {
        const savedLocations = localStorage.getItem('tripLocations');
        if (savedLocations) {
          setLocations(JSON.parse(savedLocations));
        } else {
          setLocations(INITIAL_LOCATIONS);
          localStorage.setItem('tripLocations', JSON.stringify(INITIAL_LOCATIONS));
        }
        
        // Load cached routes
        const cachedRoutes = localStorage.getItem('locationRoutes');
        if (cachedRoutes) {
          try {
            setLocationRoutes(JSON.parse(cachedRoutes));
          } catch (e) {
            console.error('Failed to parse cached routes:', e);
          }
        }
        
        // Check if we should return to Map tab after reload
        if (sessionStorage.getItem('returnToMapTab') === 'true') {
          console.log('üîÑ Returning to Map tab after refresh');
          setActiveTab('map');
          sessionStorage.removeItem('returnToMapTab');
        }
        
        setIsLoading(false);

        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        
        return () => {
          window.removeEventListener('online', handleOnline);
          window.removeEventListener('offline', handleOffline);
        };
      }, []);

    // added for Fetch Mapbox token from proxy
    useEffect(() => {
      fetch(API_CONFIG.PROXY_URL + '?type=mapbox_token')
        .then(r => r.json())
        .then(data => {
          console.log('Token received:', !!data.token);
          setToken(data.token);
        })
        .catch(e => console.error('Token error:', e));
    }, []);

      // Save locations to localStorage
      useEffect(() => {
        if (locations.length > 0) {
          localStorage.setItem('tripLocations', JSON.stringify(locations));
        }
      }, [locations]);

      // Fetch routes when locations load - ALWAYS attempt fetch on first load
      useEffect(() => {
        console.log('===== ROUTE FETCH EFFECT TRIGGERED =====');
        console.log('locations.length:', locations.length);
        console.log('locationRoutes keys:', Object.keys(locationRoutes).length);
        console.log('isOnline:', isOnline);
        
        if (locations.length > 0) {
          // Check if routes already cached
          const hasRoutes = Object.keys(locationRoutes).length > 0;
          console.log('Has cached routes:', hasRoutes);
          
          if (!hasRoutes) {
            // No routes cached - fetch them
            console.log('üîÑ No cached routes found. Fetching from API...');
            fetchAllRoutes(locations);
          } else {
            console.log('‚úì Routes already cached, skipping fetch');
          }
        } else {
          console.log('‚ö†Ô∏è locations.length is 0, cannot fetch routes');
        }
      }, [locations]);

      // Fetch all routes from Mapbox Directions API
      const fetchAllRoutes = async (locs) => {
        console.log('üöÄ fetchAllRoutes STARTED with', locs.length, 'locations');
        setIsLoadingRoutes(true);
        setRouteError(null);
        const routes = {};
        let successCount = 0;
        let failCount = 0;

        try {
          console.log('Token available:', !!token);
          console.log('Token starts with:', token?.substring(0, 20) + '...');
          
          for (let i = 0; i < locs.length - 1; i++) {
            const from = locs[i];
            const to = locs[i + 1];
            const key = `${from.id}-${to.id}`;
            
            const [lng1, lat1] = from.coordinates;
            const [lng2, lat2] = to.coordinates;
            
            const url = `${API_CONFIG.PROXY_URL}?type=directions&lng1=${lng1}&lat1=${lat1}&lng2=${lng2}&lat2=${lat2}`;
            
            console.log(`[${i + 1}/${locs.length - 1}] Fetching: ${from.name} ‚Üí ${to.name}`);
            console.log('URL:', url);
            
            try {
              const response = await fetch(url);
              const data = await response.json();
              
              console.log(`Response status: ${response.status}`, 'Code:', data.code);
              
              if (data.routes && data.routes[0] && data.routes[0].geometry) {
                routes[key] = {
                  geometry: data.routes[0].geometry,
                  distance: data.routes[0].distance,
                  duration: data.routes[0].duration
                };
                successCount++;
                console.log(`‚úÖ [${i + 1}] SUCCESS: ${from.name} ‚Üí ${to.name}`);
              } else {
                failCount++;
                console.warn(`‚ùå [${i + 1}] NO ROUTE: ${from.name} ‚Üí ${to.name}`, data);
              }
            } catch (e) {
              failCount++;
              console.error(`‚ùå [${i + 1}] FETCH ERROR for ${from.name} ‚Üí ${to.name}:`, e.message);
            }
            
            // Add small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          console.log('üìä FINAL RESULTS:', `${successCount} successful, ${failCount} failed`);
          console.log('Routes object keys:', Object.keys(routes).length);
          console.log('Routes data:', routes);
          
          setLocationRoutes(routes);
          localStorage.setItem('locationRoutes', JSON.stringify(routes));
          
          console.log('üíæ Saved to localStorage');
          
          if (failCount > 0) {
            setRouteError(`Loaded ${successCount}/${locs.length - 1} routes. Some routes may display as straight lines.`);
          }
        } catch (e) {
          console.error('üí• CRITICAL ERROR in fetchAllRoutes:', e);
          setRouteError('Failed to load routes. Map will show basic connectivity.');
        } finally {
          setIsLoadingRoutes(false);
          console.log('üèÅ fetchAllRoutes COMPLETED');
        }
      };

      // Handle page visibility changes (tab switching)
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (!document.hidden && activeTab === 'map') {
            setShowRefreshPrompt(true);
            
            if (map.current) {
              try {
                const canvas = map.current.getCanvas();
                const gl = canvas.getContext('webgl') || canvas.getContext('webgl2');
                
                if (!gl || gl.isContextLost?.()) {
                  console.warn('WebGL context lost - map needs refresh');
                  setMapContextLost(true);
                }
              } catch (e) {
                console.error('Error checking WebGL context:', e);
              }
            }
          }
        };
        
        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, [activeTab]);


      useEffect(() => {
        if (activeTab === 'map' && mapContainer.current) {
          const handleContextLost = (e) => {
            console.warn('WebGL contextlost event fired');
            e.preventDefault();
            setMapContextLost(true);
            setShowRefreshPrompt(true);
          };
          
          const handleContextRestored = () => {
            console.log('WebGL context restored');
            setMapContextLost(false);
            setShowRefreshPrompt(false);
          };
          
          const canvas = mapContainer.current.querySelector('canvas');
          if (canvas) {
            canvas.addEventListener('webglcontextlost', handleContextLost, false);
            canvas.addEventListener('webglcontextrestored', handleContextRestored, false);
            
            return () => {
              canvas.removeEventListener('webglcontextlost', handleContextLost);
              canvas.removeEventListener('webglcontextrestored', handleContextRestored);
            };
          }
        }
      }, [activeTab]);

      // Initialize Mapbox map
      useEffect(() => {
        if (activeTab === 'map' && mapContainer.current && !map.current && token !== 'token') {
          console.log('üó∫Ô∏è Initializing Mapbox map');
          mapboxgl.accessToken = token;
          
          map.current = new mapboxgl.Map({
            container: mapContainer.current,
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [176.5, -39.5],
            zoom: 6
          });

          map.current.addControl(new mapboxgl.NavigationControl());

          map.current.on('load', () => {
            console.log('üìç Map load event fired');
            console.log('üìç locationRoutes available:', Object.keys(locationRoutes).length);
            
            // Add markers for all locations
            locations.forEach((location) => {
              const el = document.createElement('div');
              el.className = 'marker';
              el.style.backgroundColor = location.visited ? '#9CA3AF' : '#3B82F6';
              el.style.width = '30px';
              el.style.height = '30px';
              el.style.borderRadius = '50%';
              el.style.display = 'flex';
              el.style.alignItems = 'center';
              el.style.justifyContent = 'center';
              el.style.color = 'white';
              el.style.fontWeight = 'bold';
              el.style.fontSize = '14px';
              el.style.border = '2px solid white';
              el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
              el.textContent = sequenceNumber; // Add sequence number inside marker 1, 2, 3, etc.;

              new mapboxgl.Marker(el)
                .setLngLat(location.coordinates)
                .setPopup(
                  new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                      <div style="padding: 5px;">
                        <strong>${location.name}</strong><br/>
                        <small>${location.address}</small>
                      </div>
                    `)
                )
                .addTo(map.current);
            });

            console.log('‚úÖ Markers added to map');
            
            // NOW render routes after markers are added
            if (Object.keys(locationRoutes).length > 0) {
              console.log('üõ£Ô∏è Rendering', Object.keys(locationRoutes).length, 'routes');
              
              try {
                const features = Object.entries(locationRoutes).map(([key, routeData]) => {
                  console.log(`Creating feature for route: ${key}`);
                  return {
                    type: 'Feature',
                    geometry: routeData.geometry,
                    properties: {
                      distance: routeData.distance,
                      duration: routeData.duration
                    }
                  };
                });

                console.log('Adding route source with', features.length, 'features');

                map.current.addSource('route', {
                  'type': 'geojson',
                  'data': {
                    'type': 'FeatureCollection',
                    'features': features
                  }
                });

                console.log('Adding route layer');

                map.current.addLayer({
                  'id': 'route',
                  'type': 'line',
                  'source': 'route',
                  'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                  },
                  'paint': {
                    'line-color': '#3B82F6',
                    'line-width': 3,
                    'line-opacity': 0.7
                  }
                });
                
                console.log('üéâ Routes rendered successfully!');
              } catch (e) {
                console.error('‚ùå Error rendering routes:', e.message);
              }
            } else {
              console.log('‚ö†Ô∏è No routes available to render');
            }

            setMapContextLost(false);
            setShowRefreshPrompt(false);
          });
        }
      }, [activeTab, locations, locationRoutes]);

      useEffect(() => {
        const nextLoc = getNextLocation();
        if (nextLoc && isOnline && API_CONFIG.OPENWEATHER_KEY !== 'YOUR_OPENWEATHER_API_KEY_HERE') {
          fetchWeather(nextLoc);
        }
      }, [locations, isOnline]);

      const fetchWeather = async (location) => {
        setLoadingWeather(true);
        const [lng, lat] = location.coordinates;
        
        try {
          const response = await fetch(
            `${API_CONFIG.PROXY_URL}?type=weather&lat=${lat}&lon=${lng}`
          );
          const data = await response.json();
          setWeather({
            temp: Math.round(data.main.temp),
            condition: data.weather[0].main,
            description: data.weather[0].description
          });
        } catch (error) {
          console.error('Weather fetch failed:', error);
          setWeather(null);
        } finally {
          setLoadingWeather(false);
        }
      };

      const calculateProgress = () => {
        const visitedCount = locations.filter(loc => loc.visited).length;
        const totalCount = locations.length;
        const remainingCount = totalCount - visitedCount;
        
        const unvisitedDays = [...new Set(
          locations.filter(loc => !loc.visited).map(loc => loc.day)
        )].length;
        
        return {
          visited: visitedCount,
          total: totalCount,
          remaining: remainingCount,
          remainingDays: unvisitedDays,
          percentage: Math.round((visitedCount / totalCount) * 100)
        };
      };

      const getCurrentLocation = () => {
        return locations.find(loc => !loc.visited);
      };

      const getNextLocation = () => {
        const unvisited = locations.filter(loc => !loc.visited);
        return unvisited.length > 1 ? unvisited[1] : null;
      };

      const markAsVisited = (locationId) => {
        setLocations(prev => 
          prev.map(loc => 
            loc.id === locationId ? { ...loc, visited: true } : loc
          )
        );
      };

      const openGoogleMaps = (location) => {
        const query = encodeURIComponent(location.googleMapsQuery || location.name + ', ' + location.address);
        const url = `https://www.google.com/maps/search/?api=1&query=${query}`;
        window.open(url, '_blank');
      };

      const refreshPage = () => {
        console.log('üîÑ REFRESH CLICKED - Reloading map only');
        setIsRefreshing(true);
        
        // Store that we're on map tab so we can return to it
        sessionStorage.setItem('returnToMapTab', 'true');
        
        // Small delay then reload
        setTimeout(() => {
          window.location.reload();
        }, 100);
      };

      const progress = calculateProgress();
      const currentLocation = getCurrentLocation();
      const nextLocation = getNextLocation();

      if (isLoading) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-50">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-4 text-gray-600">Loading your trip...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-md mx-auto bg-white min-h-screen flex flex-col">
          <div className="bg-blue-600 text-white p-4 shadow-lg">
            <div className="flex items-center justify-between mb-3">
              <h1 className="text-xl font-bold">Road Trip Planner</h1>
              <div className="flex items-center gap-2">
                {isOnline ? <WifiIcon /> : (
                  <div className="flex items-center gap-1">
                    <WifiOffIcon />
                    <span className="text-xs text-yellow-300">Offline</span>
                  </div>
                )}
              </div>
            </div>
            
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>{progress.remaining} places to go</span>
                <span>{progress.remainingDays} days left</span>
              </div>
              <div className="w-full bg-blue-800 rounded-full h-3">
                <div 
                  className="bg-green-400 h-3 rounded-full transition-all duration-500"
                  style={{ width: `${progress.percentage}%` }}
                />
              </div>
              <div className="text-sm text-center">
                {progress.visited} of {progress.total} completed ({progress.percentage}%)
              </div>
            </div>
          </div>

          <div className="flex border-b bg-white sticky top-0 z-10 shadow-sm">
            <button
              onClick={() => setActiveTab('current')}
              className={`flex-1 py-3 flex items-center justify-center gap-2 transition-colors ${
                activeTab === 'current' ? 'border-b-2 border-blue-600 text-blue-600 bg-blue-50' : 'text-gray-600'
              }`}
            >
              <NavigationIcon />
              <span className="font-medium">Current</span>
            </button>
            <button
              onClick={() => {
                console.log('üó∫Ô∏è Map tab clicked');
                setActiveTab('map');
              }}
              className={`flex-1 py-3 flex items-center justify-center gap-2 transition-colors ${
                activeTab === 'map' ? 'border-b-2 border-blue-600 text-blue-600 bg-blue-50' : 'text-gray-600'
              }`}
            >
              <MapIcon />
              <span className="font-medium">Map</span>
            </button>
            <button
              onClick={() => setActiveTab('overview')}
              className={`flex-1 py-3 flex items-center justify-center gap-2 transition-colors ${
                activeTab === 'overview' ? 'border-b-2 border-blue-600 text-blue-600 bg-blue-50' : 'text-gray-600'
              }`}
            >
              <ListIcon />
              <span className="font-medium">Overview</span>
            </button>
          </div>

          <div className="flex-1 overflow-auto bg-gray-50 relative">
            {/* Map always mounted (not conditionally rendered) */}
            <div 
              ref={mapContainer} 
              id="map"
              style={{
                display: activeTab === 'map' ? 'block' : 'none',
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0
              }}
            />
            
            {activeTab === 'current' && (
              <div className="p-4 space-y-4">
                {isLoadingRoutes && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center gap-3">
                    <LoadingIcon />
                    <div>
                      <p className="font-semibold text-blue-900 text-sm">Loading route maps...</p>
                      <p className="text-xs text-blue-700">Fetching driving routes from Mapbox</p>
                    </div>
                  </div>
                )}

                {routeError && (
                  <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
                    <p className="text-sm text-yellow-800">{routeError}</p>
                  </div>
                )}

                {currentLocation ? (
                  <>
                    <div className="border-2 border-green-500 rounded-xl p-4 bg-white shadow-md">
                      <div className="flex items-center gap-3 mb-3">
                        <div className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow">
                          {currentLocation.dayNumber}
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <h3 className="font-bold text-lg">{currentLocation.name}</h3>
                            <MapPinIcon />
                          </div>
                          <p className="text-sm text-gray-600">{currentLocation.address}</p>
                        </div>
                      </div>
                      
                      <div className="bg-green-50 rounded-lg p-3 mb-3 border border-green-200">
                        <p className="text-sm text-gray-700">
                          <span className="font-semibold text-green-800">Day:</span> {currentLocation.day}
                        </p>
                        {currentLocation.notes && (
                          <p className="text-sm text-gray-700 mt-1">
                            <span className="font-semibold text-green-800">Note:</span> {currentLocation.notes}
                          </p>
                        )}
                      </div>
                      
                      {false && ( // Temporarily disable booking display for current location
                        <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-3 flex items-start gap-2">
                          <CalendarIcon />
                          <div>
                            <p className="font-semibold text-yellow-900 text-sm">Booking Confirmed</p>
                            <p className="text-sm text-yellow-800">
                              {currentLocation.booking.time} on {currentLocation.booking.date}
                            </p>
                          </div>
                        </div>
                      )}
                      
                      <button
                        onClick={() => markAsVisited(currentLocation.id)}
                        className="w-full bg-green-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-green-700 transition-colors font-medium shadow-sm"
                      >
                        <CheckIcon />
                        Mark as Visited
                      </button>
                    </div>

                    {nextLocation && (
                      <div className="border-2 border-blue-500 rounded-xl p-4 bg-white shadow-md">
                        <div className="flex items-center gap-2 mb-3">
                          <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow">
                            {nextLocation.dayNumber}
                          </div>
                          <div className="flex-1">
                            <h3 className="font-bold text-lg text-blue-900">Next Stop</h3>
                            <h4 className="font-semibold text-gray-800">{nextLocation.name}</h4>
                            <p className="text-sm text-gray-600">{nextLocation.address}</p>
                          </div>
                        </div>
                        
                        <div className="bg-blue-50 rounded-lg p-3 mb-3 border border-blue-200">
                          <p className="text-sm text-gray-700">
                            <span className="font-semibold text-blue-800">Day:</span> {nextLocation.day}
                          </p>
                          {nextLocation.notes && (
                            <p className="text-sm text-gray-700 mt-1">
                              <span className="font-semibold text-blue-800">Note:</span> {nextLocation.notes}
                            </p>
                          )}
                        </div>
                        
                        {false && ( // Temporarily disable booking display for next location
                          <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-3 flex items-start gap-2">
                            <CalendarIcon />
                            <div>
                              <p className="font-semibold text-yellow-900 text-sm">‚ö†Ô∏è Booking Confirmed</p>
                              <p className="text-sm text-yellow-800">
                                {nextLocation.booking.time} on {nextLocation.booking.date}
                              </p>
                            </div>
                          </div>
                        )}
                        
                        {weather && !loadingWeather && (
                          <div className="bg-white border border-gray-200 rounded-lg p-3 mb-3 flex items-center gap-3">
                            <CloudIcon />
                            <div className="flex-1">
                              <p className="font-semibold text-gray-800">{weather.temp}¬∞C</p>
                              <p className="text-sm text-gray-600 capitalize">{weather.description}</p>
                            </div>
                          </div>
                        )}
                        
                        {loadingWeather && (
                          <div className="bg-gray-50 rounded-lg p-3 mb-3 text-center">
                            <p className="text-sm text-gray-500">Loading weather...</p>
                          </div>
                        )}
                        
                        <button
                          onClick={() => openGoogleMaps(nextLocation)}
                          className="w-full bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors font-medium shadow-sm"
                        >
                          <ExternalLinkIcon />
                          Navigate with Google Maps
                        </button>
                      </div>
                    )}
                  </>
                ) : (
                  <div className="text-center py-16">
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <CheckIcon />
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Trip Complete! üéâ</h2>
                    <p className="text-gray-600">You've visited all {locations.length} locations</p>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'map' && (
              <div className="h-full min-h-screen">
                {token === 'token' && (
                  <div className="flex items-center justify-center h-full bg-gradient-to-br from-blue-50 to-blue-100 p-8">
                    <div className="text-center max-w-md">
                      <div className="w-24 h-24 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-6">
                        <MapIcon />
                      </div>
                      <h3 className="text-xl font-bold text-gray-800 mb-3">Add Mapbox Token</h3>
                      <p className="text-gray-600 mb-4">
                        To display the interactive map, add your Mapbox access token
                      </p>
                      <div className="bg-white rounded-lg p-4 text-left shadow-md">
                        <p className="text-sm text-gray-700 mb-2">
                          <span className="font-semibold">Steps:</span>
                        </p>
                        <ol className="text-sm text-gray-600 space-y-1 list-decimal list-inside">
                          <li>Get free token at mapbox.com/account</li>
                          <li>Add to API_CONFIG at top of HTML file</li>
                          <li>Reload page to see map with all locations</li>
                        </ol>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'overview' && (
              <div className="p-4 space-y-4">
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                  <h3 className="font-bold text-xl mb-4">Trip Summary</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <p className="text-blue-100 text-sm">Total Locations</p>
                      <p className="font-bold text-2xl">{locations.length}</p>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <p className="text-blue-100 text-sm">Completed</p>
                      <p className="font-bold text-2xl">{progress.visited}</p>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <p className="text-blue-100 text-sm">Trip Duration</p>
                      <p className="font-bold text-2xl">6 days</p>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <p className="text-blue-100 text-sm">Bookings</p>
                      <p className="font-bold text-2xl">
                        {locations.filter(l => l.booking.hasBooking).length}
                      </p>
                    </div>
                  </div>
                </div>

                {[...new Set(locations.map(l => l.day))].map(day => {
                  const dayLocations = locations.filter(l => l.day === day);
                  const allVisited = dayLocations.every(l => l.visited);
                  
                  return (
                    <div key={day} className="bg-white rounded-xl shadow-md overflow-hidden">
                      <div className={`p-4 ${allVisited ? 'bg-green-50' : 'bg-blue-50'} border-b border-gray-200`}>
                        <div className="flex items-center justify-between">
                          <h3 className="font-bold text-gray-800 capitalize text-lg">{day}</h3>
                          {allVisited && (
                            <div className="flex items-center gap-1 text-green-600">
                              <CheckIcon />
                              <span className="text-sm font-medium">Complete</span>
                            </div>
                          )}
                        </div>
                        <p className="text-sm text-gray-600 mt-1">
                          {dayLocations.length} location{dayLocations.length > 1 ? 's' : ''}
                        </p>
                      </div>
                      
                      <div className="p-3 space-y-2">
                        {dayLocations.map((location) => (
                          <div
                            key={location.id}
                            className={`rounded-lg p-3 transition-colors ${
                              location.visited 
                                ? 'bg-gray-100 border border-gray-200' 
                                : 'bg-white border-2 border-blue-200'
                            }`}
                          >
                            <div className="flex items-start gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0 ${
                                location.visited ? 'bg-gray-400' : 'bg-blue-600'
                              }`}>
                                {location.dayNumber}
                              </div>
                              <div className="flex-1 min-w-0">
                                <h4 className="font-semibold text-gray-800">{location.name}</h4>
                                <p className="text-sm text-gray-600 truncate">{location.address}</p>
                                {location.notes && (
                                  <p className="text-xs text-gray-500 mt-1 italic">{location.notes}</p>
                                )}
                                {location.booking.hasBooking && (
                                  <div className="flex items-center gap-1 mt-2 text-yellow-700 bg-yellow-50 rounded px-2 py-1 text-xs inline-flex">
                                    <CalendarIcon />
                                    <span className="font-medium">{location.booking.time}</span>
                                  </div>
                                )}
                              </div>
                              {location.visited && (
                                <CheckIcon />
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<RoadTripPlanner />);
